<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Login - marziale.tech</title>
  <script src="https://unpkg.com/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      background: #000;
      min-height: 100vh;
      font-family: 'Courier New', monospace;
      color: #fff;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .login-container {
      width: 90%;
      max-width: 400px;
      padding: 2rem;
    }

    .back-link {
      display: inline-block;
      color: #666;
      text-decoration: none;
      margin-bottom: 2rem;
      font-size: 14px;
      transition: color 0.2s;
    }

    .back-link:hover {
      color: #fff;
    }

    h1 {
      font-size: 1.5rem;
      margin-bottom: 0.5rem;
      color: #0f0;
    }

    .subtitle {
      color: #666;
      font-size: 14px;
      margin-bottom: 2rem;
    }

    .auth-form {
      background: #111;
      border: 1px solid #333;
      padding: 2rem;
      border-radius: 8px;
    }

    .form-title {
      font-size: 1.2rem;
      margin-bottom: 1.5rem;
      text-align: center;
    }

    .auth-error {
      color: #ff4040;
      font-size: 12px;
      margin-bottom: 1rem;
      text-align: center;
      min-height: 1.2em;
    }

    .auth-error.success {
      color: #0f0;
    }

    input {
      width: 100%;
      padding: 12px;
      margin-bottom: 1rem;
      background: #000;
      border: 1px solid #333;
      color: #fff;
      font-family: 'Courier New', monospace;
      font-size: 14px;
      border-radius: 4px;
    }

    input:focus {
      outline: none;
      border-color: #0f0;
    }

    input::placeholder {
      color: #666;
    }

    .submit-btn {
      width: 100%;
      padding: 12px;
      background: #0f0;
      border: none;
      color: #000;
      font-family: 'Courier New', monospace;
      font-size: 14px;
      font-weight: bold;
      cursor: pointer;
      border-radius: 4px;
      transition: background 0.2s;
    }

    .submit-btn:hover {
      background: #0c0;
    }

    .submit-btn:disabled {
      background: #333;
      color: #666;
      cursor: not-allowed;
    }

    .auth-toggle {
      text-align: center;
      margin-top: 1.5rem;
      font-size: 12px;
      color: #666;
    }

    .auth-toggle a {
      color: #0f0;
      cursor: pointer;
      text-decoration: none;
    }

    .auth-toggle a:hover {
      text-decoration: underline;
    }

    .logged-in-view {
      text-align: center;
    }

    .logged-in-view h2 {
      color: #0f0;
      margin-bottom: 1rem;
    }

    .user-email {
      color: #fff;
      margin-bottom: 2rem;
      word-break: break-all;
    }

    .logout-btn {
      padding: 12px 24px;
      background: transparent;
      border: 1px solid #666;
      color: #666;
      font-family: 'Courier New', monospace;
      font-size: 14px;
      cursor: pointer;
      border-radius: 4px;
      transition: all 0.2s;
    }

    .logout-btn:hover {
      border-color: #ff4040;
      color: #ff4040;
    }

    .home-btn {
      display: inline-block;
      margin-top: 1rem;
      padding: 12px 24px;
      background: #0f0;
      color: #000;
      text-decoration: none;
      font-size: 14px;
      border-radius: 4px;
      transition: background 0.2s;
    }

    .home-btn:hover {
      background: #0c0;
    }

    .hidden {
      display: none;
    }

    .status {
      position: fixed;
      bottom: 20px;
      right: 20px;
      font-size: 12px;
      color: #333;
    }

    .status.connected {
      color: #0f0;
    }

    .status.error {
      color: #ff4040;
    }

    .version-display {
      position: fixed;
      top: 10px;
      right: 10px;
      background: rgba(0, 0, 0, 0.8);
      padding: 8px 12px;
      border-radius: 4px;
      font-size: 12px;
      z-index: 9999;
      display: none;
      border: 1px solid #333;
    }

    .version-display.visible {
      display: block;
    }

    .version-number {
      color: #0f0;
      font-weight: bold;
      margin-right: 8px;
    }

    .version-desc {
      color: #888;
    }
  </style>
</head>
<body>
  <div class="login-container">
    <a href="/" class="back-link">&larr; Back to home</a>
    
    <h1>marziale.tech</h1>
    <p class="subtitle">Account Login</p>

    <!-- Login Form (shown when logged out) -->
    <div id="authForm" class="auth-form">
      <h2 id="formTitle" class="form-title">Login</h2>
      <div id="authError" class="auth-error"></div>
      
      <input type="email" id="email" placeholder="Email" autocomplete="email">
      <input type="password" id="password" placeholder="Password" autocomplete="current-password">
      
      <button id="submitBtn" class="submit-btn">Login</button>
      
      <div class="auth-toggle">
        <span id="toggleText">Don't have an account? </span>
        <a id="toggleLink">Sign up</a>
      </div>
    </div>

    <!-- Logged In View (shown when logged in) -->
    <div id="loggedInView" class="auth-form logged-in-view hidden">
      <h2>Welcome!</h2>
      <p class="user-email" id="userEmail"></p>
      <button id="logoutBtn" class="logout-btn">Logout</button>
      <br>
      <a href="/" class="home-btn">Go to Homepage</a>
    </div>
  </div>

  <div id="status" class="status">Connecting...</div>

  <!-- Version display (toggle with 'v' key) -->
  <div class="version-display" id="versionDisplay">
    <span class="version-number">v0.3</span>
    <span class="version-desc">unpkg CDN + retry logic</span>
  </div>

  <script>
    // Supabase Configuration
    const SUPABASE_URL = 'https://nkhsbiqvnhvbfsxktzkc.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5raHNiaXF2bmh2YmZzeGt0emtjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjkxMDk0OTgsImV4cCI6MjA4NDY4NTQ5OH0.gni7QrH1JErkHxtz0iaJiESPO1MhAtKa8okV2UUqQaI';

    // Elements
    const authForm = document.getElementById('authForm');
    const loggedInView = document.getElementById('loggedInView');
    const formTitle = document.getElementById('formTitle');
    const authError = document.getElementById('authError');
    const emailInput = document.getElementById('email');
    const passwordInput = document.getElementById('password');
    const submitBtn = document.getElementById('submitBtn');
    const toggleText = document.getElementById('toggleText');
    const toggleLink = document.getElementById('toggleLink');
    const userEmail = document.getElementById('userEmail');
    const logoutBtn = document.getElementById('logoutBtn');
    const statusEl = document.getElementById('status');

    let supabase = null;
    let isSignUpMode = false;

    // Initialize Supabase
    function initSupabase() {
      try {
        // UMD bundle exposes as window.supabase
        if (window.supabase && typeof window.supabase.createClient === 'function') {
          supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
          statusEl.textContent = 'Connected';
          statusEl.className = 'status connected';
          console.log('Supabase client created successfully');
          return true;
        } else {
          console.log('Supabase not ready yet, window.supabase =', window.supabase);
          return false;
        }
      } catch (err) {
        statusEl.textContent = 'Error: ' + err.message;
        statusEl.className = 'status error';
        console.error('Supabase init error:', err);
        return false;
      }
    }
    
    // Retry initialization until it works (CDN might be slow)
    function tryInit(attempts) {
      if (initSupabase()) return;
      if (attempts > 0) {
        setTimeout(() => tryInit(attempts - 1), 300);
      } else {
        statusEl.textContent = 'Failed to load Supabase';
        statusEl.className = 'status error';
      }
    }
    
    tryInit(10); // Try up to 10 times over 3 seconds

    // Update UI based on auth state
    function showLoggedIn(user) {
      authForm.classList.add('hidden');
      loggedInView.classList.remove('hidden');
      userEmail.textContent = user.email;
    }

    function showLoggedOut() {
      authForm.classList.remove('hidden');
      loggedInView.classList.add('hidden');
      authError.textContent = '';
      authError.className = 'auth-error';
    }

    // Toggle signup/login mode
    toggleLink.addEventListener('click', () => {
      isSignUpMode = !isSignUpMode;
      authError.textContent = '';
      authError.className = 'auth-error';
      
      if (isSignUpMode) {
        formTitle.textContent = 'Sign Up';
        submitBtn.textContent = 'Sign Up';
        toggleText.textContent = 'Already have an account? ';
        toggleLink.textContent = 'Login';
      } else {
        formTitle.textContent = 'Login';
        submitBtn.textContent = 'Login';
        toggleText.textContent = "Don't have an account? ";
        toggleLink.textContent = 'Sign up';
      }
    });

    // Handle form submission
    submitBtn.addEventListener('click', async () => {
      console.log('Submit clicked, isSignUpMode:', isSignUpMode);
      
      const email = emailInput.value.trim();
      const password = passwordInput.value;

      if (!email || !password) {
        authError.textContent = 'Please enter email and password';
        authError.className = 'auth-error';
        return;
      }

      if (password.length < 6) {
        authError.textContent = 'Password must be at least 6 characters';
        authError.className = 'auth-error';
        return;
      }

      if (!supabase) {
        authError.textContent = 'Supabase not connected - refresh page';
        authError.className = 'auth-error';
        return;
      }

      submitBtn.disabled = true;
      submitBtn.textContent = 'Please wait...';
      authError.textContent = '';

      try {
        let result;
        
        if (isSignUpMode) {
          console.log('Attempting signup for:', email);
          result = await supabase.auth.signUp({ email, password });
          console.log('Signup result:', result);
        } else {
          console.log('Attempting login for:', email);
          result = await supabase.auth.signInWithPassword({ email, password });
          console.log('Login result:', result);
        }

        if (result.error) {
          authError.textContent = result.error.message;
          authError.className = 'auth-error';
        } else if (isSignUpMode && result.data.user && !result.data.session) {
          // Email confirmation required
          authError.textContent = 'Check your email to confirm your account!';
          authError.className = 'auth-error success';
        } else if (result.data.user) {
          showLoggedIn(result.data.user);
        }
      } catch (err) {
        authError.textContent = 'Error: ' + err.message;
        authError.className = 'auth-error';
        console.error('Auth error:', err);
      }

      submitBtn.disabled = false;
      submitBtn.textContent = isSignUpMode ? 'Sign Up' : 'Login';
    });

    // Handle Enter key
    passwordInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        submitBtn.click();
      }
    });

    emailInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        passwordInput.focus();
      }
    });

    // Handle logout
    logoutBtn.addEventListener('click', async () => {
      if (supabase) {
        await supabase.auth.signOut();
        showLoggedOut();
      }
    });

    // Check for existing session
    async function checkSession() {
      if (!supabase) return;

      try {
        const { data } = await supabase.auth.getSession();
        if (data?.session?.user) {
          showLoggedIn(data.session.user);
        }

        // Listen for auth changes
        supabase.auth.onAuthStateChange((event, session) => {
          if (session?.user) {
            showLoggedIn(session.user);
          } else {
            showLoggedOut();
          }
        });
      } catch (err) {
        console.error('Session check failed:', err);
      }
    }

    checkSession();

    // Toggle version display with 'v' key
    document.addEventListener('keydown', (e) => {
      if ((e.key === 'v' || e.key === 'V') && !e.repeat) {
        document.getElementById('versionDisplay').classList.toggle('visible');
      }
    });
  </script>
</body>
</html>
